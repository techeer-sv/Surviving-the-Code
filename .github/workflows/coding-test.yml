name: ğŸ” Coding Test Verification

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [main, master]

jobs:
  lint-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸ” Detect changed files
      id: changes
      run: |
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          # PRì—ì„œ ë³€ê²½ëœ íŒŒì¼ë“¤ ê°ì§€
          git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} > changed_files.txt
        else
          # Pushì—ì„œ ë³€ê²½ëœ íŒŒì¼ë“¤ ê°ì§€
          git diff --name-only HEAD~1 HEAD > changed_files.txt
        fi
        
        # .md íŒŒì¼ì´ ì•„ë‹Œ ì½”ë“œ íŒŒì¼ë“¤ë§Œ í•„í„°ë§
        grep -v '\.md$' changed_files.txt | grep -E '\.(py|js|ts|java|go)$' > code_files.txt || true
        
        if [ -s code_files.txt ]; then
          echo "has_code_files=true" >> $GITHUB_OUTPUT
          echo "ğŸ“‹ ë³€ê²½ëœ ì½”ë“œ íŒŒì¼ë“¤:"
          cat code_files.txt
        else
          echo "has_code_files=false" >> $GITHUB_OUTPUT
          echo "âŒ ë³€ê²½ëœ ì½”ë“œ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."
        fi

    - name: ğŸ Setup Python
      if: steps.changes.outputs.has_code_files == 'true'
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: â˜• Setup Java
      if: steps.changes.outputs.has_code_files == 'true'
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: ğŸš€ Setup Node.js
      if: steps.changes.outputs.has_code_files == 'true'
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: ğŸ¹ Setup Go
      if: steps.changes.outputs.has_code_files == 'true'
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'
        cache: false

    - name: ğŸ” Install Linters
      if: steps.changes.outputs.has_code_files == 'true'
      run: |
        echo "ğŸ”§ Installing linters for all languages..."
        
        # Python linters
        python3 -m pip install --upgrade pip
        pip install flake8 black isort
        
        # JavaScript linters
        npm install -g eslint prettier @eslint/create-config
        
        # Go linters
        go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest
        
        # Java linters (checkstyle)
        wget -q https://github.com/checkstyle/checkstyle/releases/download/checkstyle-10.12.4/checkstyle-10.12.4-all.jar -O checkstyle.jar
        
        echo "âœ… All linters installed successfully!"

    - name: ğŸ§¹ Run Lint Tests
      if: steps.changes.outputs.has_code_files == 'true'
      run: |
        echo "ğŸ” Running lint tests on changed files..."
        
        lint_success=0
        lint_total=0
        
        while IFS= read -r file; do
          if [ ! -f "$file" ]; then
            continue
          fi
          
          echo "ğŸ” Linting: $file"
          lint_total=$((lint_total + 1))
          
          case "$file" in
            *.py)
              echo "ğŸ Running Python linters via script..."
              chmod +x scripts/lint_python.sh
              if ./scripts/lint_python.sh "$file"; then
                echo "âœ… $file passed Python lint"
                lint_success=$((lint_success + 1))
              else
                echo "âŒ $file failed Python lint"
              fi
              ;;
              
            *.js)
              echo "ğŸš€ Running JavaScript linters..."
              lint_passed=true
              
              # ESLint (if .eslintrc exists or create basic config)
              if [ ! -f ".eslintrc.json" ] && [ ! -f ".eslintrc.js" ]; then
                echo '{"extends": ["eslint:recommended"], "env": {"node": true, "es6": true}, "parserOptions": {"ecmaVersion": 2022}}' > .eslintrc.json
              fi
              
              if ! npx eslint "$file"; then
                echo "âŒ ESLint issues found in $file"
                lint_passed=false
              fi
              
              # Prettier (formatter check)
              if ! npx prettier --check "$file"; then
                echo "âŒ Prettier formatting issues found in $file"
                lint_passed=false
              fi
              
              if $lint_passed; then
                echo "âœ… $file passed JavaScript lint"
                lint_success=$((lint_success + 1))
              fi
              ;;
              
            *.java)
              echo "â˜• Running Java linters..."
              if java -jar checkstyle.jar -c checkstyle.xml "$file"; then
                echo "âœ… $file passed Java lint"
                lint_success=$((lint_success + 1))
              else
                echo "âŒ $file failed Java lint"
              fi
              ;;
              
            *.go)
              echo "ğŸ¹ Running Go linters..."
              lint_passed=true
              
              # gofmt (formatter check)
              if [ "$(gofmt -l "$file")" ]; then
                echo "âŒ Go formatting issues found in $file"
                gofmt -d "$file"
                lint_passed=false
              fi
              
              # golangci-lint
              if ! golangci-lint run "$file"; then
                echo "âŒ Golangci-lint issues found in $file"
                lint_passed=false
              fi
              
              if $lint_passed; then
                echo "âœ… $file passed Go lint"
                lint_success=$((lint_success + 1))
              fi
              ;;
              
            *)
              echo "âš ï¸ $file: No linter configured for this file type"
              lint_success=$((lint_success + 1))  # Skip unknown files
              ;;
          esac
          echo "---"
        done < code_files.txt
        
        echo "ğŸ” Lint Results Summary:"
        echo "- Total files linted: $lint_total"
        echo "- Files passed: $lint_success"
        echo "- Files failed: $((lint_total - lint_success))"
        
        if [ $lint_success -eq $lint_total ]; then
          echo "âœ… All files passed lint checks!"
        else
          echo "âŒ Some files failed lint checks."
          exit 1
        fi

    - name: ğŸ§ª Run Code Tests
      if: steps.changes.outputs.has_code_files == 'true'
      run: |
        echo "ğŸ” ì½”ë“œ íŒŒì¼ ì‹¤í–‰ ë° ê²€ì¦ ì‹œì‘..."
        
        success_count=0
        total_count=0
        
        while IFS= read -r file; do
          if [ ! -f "$file" ]; then
            continue
          fi
          
          echo "ğŸ“„ Testing: $file"
          total_count=$((total_count + 1))
          
          # íŒŒì¼ í™•ì¥ìì— ë”°ë¼ ì‹¤í–‰
          case "$file" in
            *.py)
              echo "ğŸ Running Python file..."
              if timeout 30s python3 "$file"; then
                echo "âœ… $file ì‹¤í–‰ ì„±ê³µ"
                success_count=$((success_count + 1))
              else
                echo "âŒ $file ì‹¤í–‰ ì‹¤íŒ¨"
              fi
              ;;
            *.java)
              echo "â˜• Running Java file..."
              # íŒ¨í‚¤ì§€ êµ¬ì¡°ë¥¼ ê³ ë ¤í•œ ì»´íŒŒì¼ ë° ì‹¤í–‰
              dir_path=$(dirname "$file")
              class_name=$(basename "$file" .java)
              package_path=$(echo "$dir_path" | tr '/' '.')
              
              # ì»´íŒŒì¼ ì‹œ ì†ŒìŠ¤ ê²½ë¡œì™€ ì¶œë ¥ ë””ë ‰í† ë¦¬ ì§€ì •
              mkdir -p target/classes
              if javac -d target/classes "$file" && \
                 cd target/classes && \
                 java "$package_path.$class_name"; then
                echo "âœ… $file ì‹¤í–‰ ì„±ê³µ"
                success_count=$((success_count + 1))
              else
                echo "âŒ $file ì‹¤í–‰ ì‹¤íŒ¨"
              fi
              ;;
            *.js)
              echo "ğŸš€ Running JavaScript file..."
              if timeout 30s node "$file"; then
                echo "âœ… $file ì‹¤í–‰ ì„±ê³µ"
                success_count=$((success_count + 1))
              else
                echo "âŒ $file ì‹¤í–‰ ì‹¤íŒ¨"
              fi
              ;;
            *.go)
              echo "ğŸ¹ Running Go file..."
              if timeout 30s go run "$file"; then
                echo "âœ… $file ì‹¤í–‰ ì„±ê³µ"
                success_count=$((success_count + 1))
              else
                echo "âŒ $file ì‹¤í–‰ ì‹¤íŒ¨"
              fi
              ;;
            *)
              echo "âš ï¸ $file: ì§€ì›í•˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹"
              ;;
          esac
          echo "---"
        done < code_files.txt
        
        echo "ğŸ“Š ê²°ê³¼ ìš”ì•½:"
        echo "- ì´ íŒŒì¼ ìˆ˜: $total_count"
        echo "- ì„±ê³µí•œ íŒŒì¼: $success_count"
        echo "- ì‹¤íŒ¨í•œ íŒŒì¼: $((total_count - success_count))"
        
        if [ $success_count -eq $total_count ] && [ $total_count -gt 0 ]; then
          echo "ğŸ‰ ëª¨ë“  ì½”ë“œ íŒŒì¼ì´ ì„±ê³µì ìœ¼ë¡œ ì‹¤í–‰ë˜ì—ˆìŠµë‹ˆë‹¤!"
          exit 0
        elif [ $total_count -eq 0 ]; then
          echo "â„¹ï¸ ì‹¤í–‰í•  ì½”ë“œ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."
          exit 0
        else
          echo "ğŸ’¥ ì¼ë¶€ ì½”ë“œ íŒŒì¼ ì‹¤í–‰ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
          exit 1
        fi

    - name: ğŸ“ Comment on PR
      if: github.event_name == 'pull_request' && steps.changes.outputs.has_code_files == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          
          // ì›Œí¬í”Œë¡œìš° ê²°ê³¼ì— ë”°ë¥¸ ì½”ë©˜íŠ¸ ìƒì„±
          const workflowUrl = `${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`;
          
          let comment = `## ğŸ” ì½”ë”© í…ŒìŠ¤íŠ¸ ê²€ì¦ ê²°ê³¼\n\n`;
          comment += `ìë™ìœ¼ë¡œ ì½”ë“œë¥¼ ì‹¤í–‰í•˜ì—¬ ê²€ì¦í–ˆìŠµë‹ˆë‹¤.\n\n`;
          comment += `ğŸ“Š [ìƒì„¸ ê²°ê³¼ ë³´ê¸°](${workflowUrl})\n\n`;
          
          if (process.env.GITHUB_JOB_STATUS === 'success') {
            comment += `âœ… **ëª¨ë“  ì½”ë“œê°€ ì„±ê³µì ìœ¼ë¡œ ì‹¤í–‰ë˜ì—ˆìŠµë‹ˆë‹¤!**\n`;
          } else {
            comment += `âŒ **ì¼ë¶€ ì½”ë“œ ì‹¤í–‰ì— ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤.**\n`;
            comment += `ìœ„ ë§í¬ì—ì„œ ìƒì„¸í•œ ì˜¤ë¥˜ ë‚´ìš©ì„ í™•ì¸í•´ì£¼ì„¸ìš”.\n`;
          }
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          }); 